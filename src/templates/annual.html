<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
	<meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
	<meta http-equiv="pragma" content="no-cache">
	<meta charset = "utf-8"/>
	<title>CSE 564 Project</title>
	<script type="text/javascript" src=".\static\d3\d3.js"></script>
	<link href=".\static\css\style.css" rel="stylesheet" type="text/css" />
</head>

<body>
	<table align="center">
		<tr>
			<td>	
				<form method="post" action="{{ url_for('index') }}">
					<button id="toIndex" class="func">Homepage</button>
				</form>				
				<form method="post" action="{{ url_for('annual') }}">
					<button id="toAnnual" class="func" style="background-color: LightBlue;">Annual</button>
				</form>
			</td>
			<td>
				<h1>&nbsp;&nbsp;&nbsp; What the Times Higher Education World University Ranking tells you &nbsp;&nbsp;&nbsp;</h1>
			</td>
			<td>
				<form method="post" action="{{ url_for('changes') }}">
					<button id="toChanges" class="func">Changes</button>
				</form>
				
				<form method="post" action="{{ url_for('countries') }}">
					<button id="toCountries" class="func">Countries</button>
				</form>
			</td>
		</tr>
	</table>
	<table align="center">
		<tr>
			<td><h2>Rankings published each year</h2></td>
		</tr>
		<tr>
			<td>			
				<button id="toPCA1" class="funcc">PCA1</button>
				<button id="toPCA2" class="funcc">PCA2</button>&nbsp;&nbsp;&nbsp;
				<label><input type="radio" name="method" value="2011" id="c2011" style="cursor:pointer"> 2011</label>
				<label><input type="radio" name="method" value="2012" id="c2012" style="cursor:pointer"> 2012</label>
				<label><input type="radio" name="method" value="2013" id="c2013" style="cursor:pointer"> 2013</label>
				<label><input type="radio" name="method" value="2014" id="c2014" style="cursor:pointer"> 2014</label>
				<label><input type="radio" name="method" value="2015" id="c2015" style="cursor:pointer"> 2015</label>
				<label><input type="radio" name="method" value="2016" id="c2016" style="cursor:pointer" checked> 2016</label>&nbsp;&nbsp;&nbsp;
				<button id="toMan" class="funcc">Manifold</button>
				<button id="toClu" class="funcc">Clustering</button>
			</td>
		</tr>
	</table>
	
	<div id="canvas">
	</div>
	
	<script>
		d3.selection.prototype.moveToFront = function() {
		  return this.each(function(){
			this.parentNode.appendChild(this);
		  });
		};
		
		d3.selection.prototype.moveToBack = function() { 
			return this.each(function() { 
				var firstChild = this.parentNode.firstChild; 
				if (firstChild) { 
					this.parentNode.insertBefore(this, firstChild); 
				} 
			}); 
		};
	
		//window size
		var w = (window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth) - 50;
		var h = (window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight) - 200;

		var paddingLeft = 73, paddingRight = 20, paddingTop = 80, paddingBottom = 50;
		
		var variables = ["teach","int.","rsch.","cita.","income","# stu.","SSR","ISP","FMR"];
		var lookuptable = {}; //the location of each dimension in data matrix
		for (var i=0; i<variables.length; i++)
		{
			lookuptable[variables[i]] = i;
		}		
		
		var state = 0;
		
		var colors = [];//used to remember the color of nodes in each plot
		var radius = [];//used to remember the radius of nodes in each plot
		var opacis = [];//used to remember the opacity of nodes in each plot
	
		var tooltip = function(d, year){
			var loc = d3.mouse(d3.select("svg").node());//get mouse location
			
			d3.select("#tooltip")
				.style("left", (loc[0]-60) + "px")
				.style("top", (loc[1]+50) + "px");

			d3.select("#rank")
				.text("Rank: " + d[0]);
				
			d3.select("#name")
				.text("Name: " + d[1]);
			
			d3.select("#country")
				.text("Country: " + d[2]);
				
			d3.select("#tooltip")
				.style("visibility", "visible");
		}
				
		var tooltipHide = function(){
			d3.select("#tooltip").style("visibility", "hidden");
		}
				
		//----add legend----
		var add_legend = function(svg, w, cScale, delay){
			var tran_time_leg = 500;
		
			svg.append("rect")				
				.attr("x", w-117)
				.attr("y", 5)			
				.attr("width", 112)
				.attr("height", 155)				
				.style("fill", "lightgray")
				.style("opacity", 0)
				.transition()
				.delay(delay)
				.duration(tran_time_leg)
				.ease(d3.easeLinear)				
				.style("opacity", 0.2);
				
			for(var i = 8; i>2; i--)
			{
				svg.append("circle")
					.attr("cx", w-103)
					.attr("cy", (9-i)*25-5)					
					.attr("r", i)
					.attr("fill", cScale[i])
					.style("opacity", 0)
					.transition()
					.delay(delay)
					.duration(tran_time_leg)
					.ease(d3.easeLinear)				
					.style("opacity", 1);
				
				svg.append("text")
					.attr("class", "legend")
					.attr("x", w-83)
					.attr("y", (9-i)*25+1)					
					.text(function(){
						switch(i){
							case 8:{return "1-10";}
							case 7:{return "10-25";}
							case 6:{return "25-50";}
							case 5:{return "50-100";}
							case 4:{return "100-200";}
							case 3:{return "200-400";}
						}
					})
					.style("opacity", 0)
					.transition()
					.delay(delay+1)
					.duration(tran_time_leg)
					.ease(d3.easeLinear)				
					.style("opacity", 1);					
			}
		}
		
		var rconv = function(d)
		{
			var r = 0;
		
			if(d<='200'){r = +d;}
			else if(d.localeCompare("201-250")==0){return 225;}
			else if(d.localeCompare("251-300")==0){return 275;}
			else if(d.localeCompare("301-350")==0){return 325;}
			else if(d.localeCompare("351-400")==0){return 375;}
			else if(d.localeCompare("201-225")==0){return 213;}
			else if(d.localeCompare("226-250")==0){return 238;}
			else if(d.localeCompare("251-275")==0){return 263;}
			else if(d.localeCompare("276-300")==0){return 288;}
			else if(d.localeCompare("-")==0){return 400;}
			else{r = +d;}
			
			return r;
		}
		
		var cconv = function(d)
		{
			var r = rconv(d);
			var c = 0;
			if(r<=10){c = 8;}
			else if(r<=25){c = 7;}
			else if(r<=50){c = 6;} 
			else if(r<=100){c = 5;} 
			else if(r<=200){c = 4;} 
			else {c = 3;} 
			
			return c;
		}			
		
		var transi_s1 = function(option,i)
		{
			var node_cur = d3.select("#"+option+"_"+i);
			node_cur.attr("r",(+node_cur.attr("r")+2));
		}
		
		var transi_e1 = function(option,i)
		{
			var node_cur = d3.select("#"+option+"_"+i);
			node_cur.attr("r",(+node_cur.attr("r")-2));
		}
		
		var transi_s2 = function(fun, name, num_points)
		{
			var color;

			for (var index=0; index<3; index++)
			{
				if(index!=2){for (var j=0; j<num_points; j++){opacis.push(d3.select("#c"+index+"_"+j).style("opacity"));}}
				else
				{
					d3.selectAll(".scatter").style("opacity",0.1);
					for(var index=0; index<2; index++)
					{
						var node_cur = d3.select('circle[minea="'+fun+'_'+index+'_'+name+'"]');
						color = node_cur.style("fill");
						node_cur.attr("r",(+node_cur.attr("r")+2))
								.style("opacity",1.0);
					}
				}
			}
			
			d3.selectAll(".pclines").style("opacity",0.1);
			var line_curh = d3.select('path[mineah="'+fun+'_'+name+'"]');
			line_curh.style("stroke-width",3)
					 .style("opacity",1.0)
					 .style("stroke",color);		
			var line_cur = d3.select('path[minea="'+fun+'_'+name+'"]');
			line_cur.style("stroke-width",3)
					.style("opacity",1.0);		
		}
		
		var transi_e2 = function(fun, name, num_points)
		{
			for(var index=0; index<2; index++)
			{
				var node_cur = d3.select('circle[minea="'+fun+'_'+index+'_'+name+'"]');
				node_cur.attr("r",(+node_cur.attr("r")-2));
			}
			for (var index=0; index<2; index++)
			{
				for (var j=0; j<num_points; j++){d3.select("#c"+index+"_"+j).style("opacity",opacis.shift());}
			}
			
			var line_cur = d3.select('path[minea="'+fun+'_'+name+'"]');
			line_cur.style("stroke-width",1);
			var line_curh = d3.select('path[mineah="'+fun+'_'+name+'"]');
			line_curh.style("stroke-width",1)
					 .style("stroke","#ddd");
			d3.selectAll(".pclines").style("opacity",1);					
		}
		
		
		var transi_s3 = function(fun, num, name)
		{
		    d3.selectAll(".scatter").style("opacity",0.1);
			for(var index=0; index<num; index++)
			{
				var node_cur = d3.select('circle[minea="'+fun+'_'+index+'_'+name+'"]');
				node_cur.attr("r",(+node_cur.attr("r")+2))
						.style("opacity",1.0);
			}
		}
		
		var transi_e3 = function(fun, num, name)
		{
			for(var index=0; index<num; index++)
			{		
				var node_cur = d3.select('circle[minea="'+fun+'_'+index+'_'+name+'"]');
				node_cur.attr("r",(+node_cur.attr("r")-2));
			}
			d3.selectAll(".scatter").style("opacity",1);
		}		
		
		
	    // Clear the previously-active brush, if any.
	    function brushstart(p) {
			if (brushCell !== this) {
				d3.select(brushCell).call(brush.clear());
				x.domain(domainByTrait[p.x]);
				y.domain(domainByTrait[p.y]);
				brushCell = this;
			}
		}

	    // Highlight the selected circles.
	    function brushmove(p) {
			var e = brush.extent();
			svg.selectAll("circle").classed("hidden", function(d) {
				return e[0][0] > d[p.x] || d[p.x] > e[1][0] || e[0][1] > d[p.y] || d[p.y] > e[1][1];
			});
	    }

	    // If the brush is empty, select all circles.
	    function brushend() {
			if (brush.empty()) svg.selectAll(".hidden").classed("hidden", false);
	    }		
		
		//--------------------------------------------------------------PCA 1------------------------------------------------------------
		var toPCA1 = function(year){
			state = 1;
			
			var data_folder = "./static/data/"+year;

			d3.selectAll(".funcc").style("background-color", "beige");
			d3.select("#toPCA1").style("background-color", "LightBlue");
		
			d3.select("#canvas")
			  .selectAll("*")
			  .remove();//cleaning
			  
			var svg_top = d3.select("#canvas")
							.append("svg")
							.attr("width" , w)
							.attr("height", 40);			  

			ttip = d3.select("#canvas").append("div").attr("id","tooltip").attr("class","hidden");
			ttip.append("p").attr("id","rank");
			ttip.append("p").attr("id","name");			
			ttip.append("p").attr("id","country");		  
			  
			d3.select("#canvas")
				.style("text-align","center");
			
			var delay_time = 0;
			//-------------------------------scree plot------------------------------------
			w_pca_eig = Math.floor(w/2.1);
			h_pca_eig = Math.floor(h/1.1);
			
			var svg_pca_eig = d3.select("#canvas")
								.append("svg")
								.attr("class", "bordered")
								.attr("width" , w_pca_eig)
								.attr("height", h_pca_eig);
								
			svg_pca_eig.append("text")
						.text("the Scree Plot of Variance Represented by each PCA Component")
						.attr("class", "title")
						.attr("x", w_pca_eig/2)
						.attr("y", paddingTop/2);			
			
			d3.text(data_folder+"/pca_eig.csv", function(text) {
				var data_pca_eig_raw = d3.csvParseRows(text, function(row) {
					return row.map(function(value) { return +value;});
				});
				var num_comp = data_pca_eig_raw.length;//number of components	
				var num_sig_comp = 0;
				var data_pca_eig = [];
				for(var i=0; i<num_comp; i++)
				{
					var variance = data_pca_eig_raw[i][0];
					if(variance > 1)
					{
						num_sig_comp = num_sig_comp+1;
					}
					data_pca_eig.push(variance);
				}
			
				
				//generating bar chart
				var cScale_pca_eig = d3.schemeCategory20;
				
				
				var xAxis_pca_eig = d3.axisBottom();
				
				svg_pca_eig.append("g")
						  .attr("id", "xAxisPcaEig")
						  .attr("class", "axis")
						  .attr("transform", "translate(0, " + (h_pca_eig - paddingBottom) + ")");		

				svg_pca_eig.append("text")
						  .text("index of components")
						  .attr("class", "axisLabel")
						  .attr("x", w_pca_eig/2)
						  .attr("y", h_pca_eig-10);
				
				
				var yAxis_pca_eig = d3.axisLeft();
				
				svg_pca_eig.append("g")
						  .attr("id", "yAxisPcaEig")
						  .attr("class", "axis")
						  .attr("transform", "translate(" + paddingLeft + ", 0)");

				svg_pca_eig.append("text")
						  .text("variance")
						  .attr("class", "axisLabel")
						  .attr("transform", "translate(" + 25 + "," + (h_pca_eig/2) + ") rotate(-90)");
						  

				var xScale_pca_eig = d3.scaleBand()
										 .domain(d3.range(1, num_comp+1))
										 .rangeRound([paddingLeft, w_pca_eig-paddingRight])
										 .paddingInner(0.30);

				var ymin_pca_eig = d3.min(data_pca_eig);
				var ymax_pca_eig = d3.max(data_pca_eig);
				var yScale_pca_eig = d3.scaleLinear()//number scale
										 .domain([0, ymax_pca_eig*1.02])
										 .range([h_pca_eig-paddingBottom, paddingTop]);

				var hRects_pca_eig = svg_pca_eig.selectAll("rect")
											   .data(data_pca_eig)
											   .enter()
											   .append("rect")
											   .attr("id", function(d, i){return (d>1)?"sigcomp"+i:"normalrec"})
											   .attr("x", function(d, i){return xScale_pca_eig(i+1);})
											   .attr("y", function(d){return yScale_pca_eig(d);})
											   .attr("width", xScale_pca_eig.bandwidth())
											   .attr("height", function(d){return h_pca_eig - paddingBottom - yScale_pca_eig(d);})
											   .style("fill", d3.schemeCategory20[0]);

				var hTexts_pca_eig = svg_pca_eig.selectAll(".rectLabel")
											   .data(data_pca_eig)
											   .enter()
											   .append("text")
											   .attr("id", "rectLabel")
											   .attr("class", "label")
											   .attr("text-anchor", "middle")
											   .attr("x", function(d, i){return (xScale_pca_eig(i+1) + xScale_pca_eig.bandwidth()/2);})
											   .text(function(d){return d;})
											   .attr("y", function(d){return yScale_pca_eig(d) - 15;});	
														   
				xAxis_pca_eig.scale(xScale_pca_eig);
				d3.select("#xAxisPcaEig")
					.call(xAxis_pca_eig);
				yAxis_pca_eig.scale(yScale_pca_eig);
				d3.select("#yAxisPcaEig")
					.call(yAxis_pca_eig);
					
				var lines_pca_eig = d3.line()
										.x(function(d, i){return (xScale_pca_eig(i+1) + xScale_pca_eig.bandwidth()/2);})
										.y(function(d){return yScale_pca_eig(d);});

				var tran_circles = 800;
				var circles = svg_pca_eig.selectAll("circle")
										.data(data_pca_eig)
										.enter()
										.append("circle")										
										.attr("cx", function(d, i){return (xScale_pca_eig(i+1) + xScale_pca_eig.bandwidth()/2);})
										.attr("cy", function(d){return yScale_pca_eig(d);})
										.attr("r", 0)
										.transition()
										.duration(tran_circles)
										.ease(d3.easeExp)
										.attr("r", 5)
										.style("fill", cScale_pca_eig[2]);
				delay_time = delay_time + tran_circles;										
				
				var tran_lne = 800;
				var lines_pca_eig = svg_pca_eig.append("path")
											   .transition()
											   .delay(delay_time)
											   .duration(tran_lne)
											   .ease(d3.easeExp)
											   .attr("class", "linepcaeig")
											   .attr("d", lines_pca_eig(data_pca_eig))
											   .attr("stroke", cScale_pca_eig[4])
											   .attr("stroke-width", 4)
											   .attr("fill", "none")
											   .style("stroke-opacity", 0.5);
				delay_time = delay_time + tran_lne;	
											   
				var lines_thres = d3.line()
									.x(function(d, i){return (i==0)?paddingLeft:(w_pca_eig-paddingRight);})
									.y(function(){return yScale_pca_eig(1);});
				
				var tran_lth = 600;
				var lines_thres = svg_pca_eig.append("path")
											   .transition()
											   .delay(delay_time)
											   .duration(tran_lth)
											   .ease(d3.easeExp)
											   .attr("class", "linethres")
											   .attr("d", lines_thres(d3.range(2)))
											   .attr("stroke", cScale_pca_eig[6])
											   .attr("stroke-width", 4)
											   .attr("fill", "none")
											   .style("stroke-opacity", 0.8);
				delay_time = delay_time + tran_lth + 300;							
											   
				var widthIncreHist = 10;
				var heightIncreHist = 10;
				var tran_sig = 300;
				var linger_time = 300;
				for(var i = 0; i<num_sig_comp; i++)
				{
					svg_pca_eig.select("#sigcomp"+i)
							   .transition()
							   .delay(delay_time)
							   .duration(tran_sig)
							   .ease(d3.easeLinear)
							   .style("fill", function(){return cScale_pca_eig[1];})
							   .attr("x", function(){return (+d3.select("#sigcomp"+i).attr("x")) - widthIncreHist/2;})
							   .attr("width", function(){return (+d3.select("#sigcomp"+i).attr("width")) + widthIncreHist;})
							   .attr("height", function(){return (+d3.select("#sigcomp"+i).attr("height")) + heightIncreHist;})
							   .attr("y", function(){return (+d3.select("#sigcomp"+i).attr("y")) - heightIncreHist;});
						   
					svg_pca_eig.select("#sigcomp"+i)
							   .transition()
							   .delay(delay_time + tran_sig + linger_time)
							   .duration(tran_sig)
							   .ease(d3.easeLinear)					   
							   .attr("x", function(){return (+d3.select("#sigcomp"+i).attr("x"));})
							   .attr("width", function(){return (+d3.select("#sigcomp"+i).attr("width"));})
							   .attr("height", function(){return (+d3.select("#sigcomp"+i).attr("height"));})
							   .attr("y", function(){return (+d3.select("#sigcomp"+i).attr("y"));});
				}
				delay_time = delay_time + tran_sig + linger_time;	
			});
			
			//-------------------------------project to top two pca components--------------
			d3.select("#canvas")
			  .append("svg")
			  .attr("width", 60)
			  .attr("height",h_pca_eig);
			
			w_pca = w_pca_eig;
			h_pca = h_pca_eig;

			var svg_pca = d3.select("#canvas")
							.append("svg")
							.attr("class", "bordered")
							.attr("width" , w_pca)
							.attr("height", h_pca);
								
			svg_pca.append("text")
						.text("Data Projected onto the Top Two PCA Componenets")
						.attr("class", "title")
						.attr("x", w_pca/2)
						.attr("y", paddingTop/2);
			
			d3.text(data_folder+"/pca_2_comp.csv", function(text){
				var data_pca = d3.csvParseRows(text, function(row) {
					return row.map(function(value) { return +value;});
				});
				var num_points = data_pca.length;
				
				
				//generating bar chart
				var cScale_pca = d3.schemeCategory20;				
				
				var xAxis_pca = d3.axisBottom();
				
				svg_pca.append("g")
						.attr("id", "xAxispca")
						.attr("class", "axis")
						.attr("transform", "translate(0, " + (h_pca - paddingBottom) + ")");		
							
				var yAxis_pca = d3.axisLeft();
				
				svg_pca.append("g")
						.attr("id", "yAxispca")
						.attr("class", "axis")
						.attr("transform", "translate(" + paddingLeft + ", 0)");
						  

				var xmin_pca = d3.min(data_pca, function(d){return d[0];});
				var xmax_pca = d3.max(data_pca, function(d){return d[0];});
				var xpad = (xmax_pca - xmin_pca)*0.02;
				var xScale_pca = d3.scaleLinear()//number scale
									.domain([xmin_pca-xpad, xmax_pca+xpad])
									.range([paddingLeft, w_pca-paddingRight]);

				var ymin_pca = d3.min(data_pca, function(d){return d[1];});
				var ymax_pca = d3.max(data_pca, function(d){return d[1];});
				var ypad = (ymax_pca - ymin_pca)*0.02;
				var yScale_pca = d3.scaleLinear()//number scale
									.domain([ymin_pca-ypad, ymax_pca+ypad])
									.range([h_pca-paddingBottom, paddingTop]);
														   

				d3.text((data_folder+"/"+year+"_info.csv"), function(text) {
					var info = d3.csvParseRows(text, function(row) {
						return row.map(function(value) { return value;});
					});
					
					delay_time = delay_time + 300;
					var tran_c = 1000;
					var circles = svg_pca.selectAll("circle")
											.data(data_pca, function(d) { return d.name; })
											.enter()
											.append("circle")
											.on("mouseover", function(d,i){tooltip(info[i]);transi_s1("pca1",i);})
											.on("mouseout", function(d,i){tooltipHide(); transi_e1("pca1",i);})
											.attr("id", function(d,i){return "pca1_"+i;})
											.attr("cx", function(d){return xScale_pca(0);})
											.attr("cy", function(d){return yScale_pca(0);})
											.attr("r", 0)
											.transition()
											.delay(delay_time)
											.duration(tran_c)
											.ease(d3.easeExp)
											.attr("cx", function(d){return xScale_pca(d[0]);})
											.attr("cy", function(d){return yScale_pca(d[1]);})
											.attr("r", function(d, i){return cconv(info[i][0]);})
											.style("fill", function(d, i){return cScale_pca[cconv(info[i][0])];});
					
					
					add_legend(svg_pca, w_pca, cScale_pca, delay_time);

					svg_pca.append("text")
							.attr("class", "axisLabel")
							.attr("x", w_pca/2)
							.attr("y", h_pca-10)				
							.text("Component 1")
							.style("opacity", 0)
							.transition()
							.delay(delay_time)
							.duration(tran_c)
							.ease(d3.easeExp)				
							.style("opacity", 1);							
					xAxis_pca.scale(xScale_pca);
					d3.select("#xAxispca")
						.transition()
						.delay(delay_time)
						.duration(tran_c)
						.ease(d3.easeExp)
						.call(xAxis_pca);						
					svg_pca.append("text")
							.attr("class", "axisLabel")
							.attr("transform", "translate(" + 35 + "," + (h_pca/2) + ") rotate(-90)")
							.text("Component 2")
							.style("opacity", 0)
							.transition()
							.delay(delay_time)
							.duration(tran_c)
							.ease(d3.easeExp)				
							.style("opacity", 1);							
					yAxis_pca.scale(yScale_pca);
					d3.select("#yAxispca")
						.transition()
						.delay(delay_time)
						.duration(tran_c)
						.ease(d3.easeExp)					
						.call(yAxis_pca);
				});
			});	
		}
		
		
		//--------------------------------------------------------------PCA 2------------------------------------------------------------
		var toPCA2 = function(year){
			state = 2;
			
			var data_folder = "./static/data/"+year;
			
			d3.selectAll(".funcc").style("background-color", "beige");
			d3.select("#toPCA2").style("background-color", "LightBlue");			
		
			d3.select("#canvas")
			  .selectAll("*")
			  .remove();//cleaning
			  
			ttip = d3.select("#canvas").append("div").attr("id","tooltip").attr("class","hidden");
			ttip.append("p").attr("id","rank");
			ttip.append("p").attr("id","name");			
			ttip.append("p").attr("id","country");
			  
			var svg_top = d3.select("#canvas")
							.append("svg")
							.attr("width" , w)
							.attr("height", 40);			  
			  
			d3.select("#canvas")
				.style("text-align","center");

			w_pca_eig = Math.floor(w/2.1);
			h_pca_eig = Math.floor(h/1.1);
				
			h_pca2 = Math.floor(h_pca_eig/3.2);	  
			w_pca2 = h_pca2;			  			
						
			var middle_interval = w*0.03;
			//--------loading table-------
			var width_left = w-w_pca2*3-middle_interval-300;
			var left_canvas = d3.select("#canvas")
								.append("div")
								.attr("class","bordered")
								.style("padding","10px")
								.style("padding-left","30px")
								.style("padding-right","30px")
								.style("display","inline-block")
								.style("width", width_left+"px")
								.style("height", h_pca_eig+"px")
								.style("justify-content","center");
								
			var middle_canvas = d3.select("#canvas")
									.append("div")
									.style("display","inline-block")
									.style("width", middle_interval+"px")
									.style("height", h_pca_eig+"px")
									.style("justify-content","center");
				
			var delay_tb = 50;
			var tran_tb = 500;
			
			var title_h = 36;
			var svg_left = left_canvas.append("svg")
										.attr("width", width_left)
										.attr("height", title_h)
										.append("text")
										.attr("class", "title")
										.attr("x",width_left/2)
										.attr("y",(title_h/2))
										.text("the Sum of Squared Loadings of each Variable");
		
			var table = left_canvas.append('table').attr("class", "load");
			
			var thead = table.append('thead').attr("class", "load pca");							
			
			var	tbody = table.append('tbody').attr("class", "load pca");
					
			delay_tb = 	delay_tb + 50;								
			// append the header row

			num_vari = variables.length;
			
			d3.text(data_folder+"/loadings.csv", function(text) {
				var loadings = d3.csvParseRows(text, function(row) {
					return row.map(function(value) { return value;});
				});
				
				num_sig_attri = loadings[0].length;
				var header = d3.range(num_sig_attri+1);
				thead.append('tr')
						.selectAll('th')
						.data(header)
						.enter()
						.append('th')
						.attr("class",function(d,i){return (i==0)?"load emp":"load pca";})
						.text(function (d, i) { return (i==0)?(""):((i==num_sig_attri)?"Squared Sum":"Component "+d+" "); });						  
					  
				for(var i = 0; i<num_vari; i++)
				{
					loadings[i].unshift(variables[i]);					
				}
				// create a row for each object in the data
				var rows = tbody.selectAll('tr')
								  .data(loadings)
								  .enter()
								  .append('tr')
								  .attr("class","load");

				// create a cell in each row for each column
				var cells = rows.selectAll('td')
								.data(function (d) {return d;})
								.enter()
								.append('td')
								.attr("class",function(d,i){return (i==0)?"load vari":"load pca";})
								.text(function (d) { return d;})
								.style("opacity", 0)
								.transition()
								.delay(delay_tb)
								.duration(tran_tb)
								.ease(d3.easeLinear)				
								.style("opacity", 1);									  
			});
			
			var div_def = left_canvas.append("div")
										.style("display","inline-block")
										.style("width", width_left)
										.style("justify-content","center")
										.style("backgroundcolor","lightgray");
					
			definitions = ["Year: the year the ranking was published",
							"Rank: world rank",
							"Teach: teaching (the learning environment)",
							"Int.: international outlook (staff, students and research)",
							"Rsch.: research (volume, income and reputation)",
							"Cita.: citations (research influence)",
							"Income: industry income (knowledge transfer)",
							"# stu: number of students",
							"SSR: student-staff-ratio, the number of students divided by the number of staff",
							"ISP: international-students-percentage, how many students are international",
							"FMR: female-male-ratio, female student to Male student ratio"];
			
			div_def.append("ol")
					.attr("class","pca")
					.selectAll("li")
					.data(definitions)
					.enter()
					.append("li")
					.attr("class","pca")
					.text(function(d) { return d;});
					
						
			//--------scatter plot matrix--------
			var padLeftDelta = 20;
			var padTopDelta = 40;				
			var right_canvas = d3.select("#canvas")
									.append("div")
									.attr("class","bordered")
									.style("padding","10px")
									.style("display","inline-block")
									.style("width", (w_pca2*3+100)+"px")
									.style("height", h_pca_eig+"px");
									
										
			var delay_time = 200;
			var tran_time = 500;
									
			var svg_right = right_canvas.append("svg")
										.attr("width", w_pca2*3+90)
										.attr("height", title_h)
										.append("text")
										.attr("class", "title")
										.attr("x",(w_pca2*3+100)/2)
										.attr("y",title_h/2)
										.text("the Scatterplot Matrix of the Three Highest PCA Loaded Attributes");
														

			var pca2_draw = function(data_pca2, svg_pca2, attr1, attr2, delay_time, tran_time, attri_name, xScale_pca2, yScale_pca2, cScale_pca2, info, index){
			
				var xAxis_pca2 = d3.axisBottom();
				
				svg_pca2.append("g")
						.attr("id", "xAxispca2" + attr1 + attr2)
						.attr("class", "axis")
						.attr("transform", "translate(0, " + (h_pca2 - paddingBottom) + ")");		
								
				var yAxis_pca2 = d3.axisLeft();
				
				svg_pca2.append("g")
						.attr("id", "yAxispca2" + attr1 + attr2)
						.attr("class", "axis")
						.attr("transform", "translate(" + (paddingLeft-padLeftDelta) + ", 0)");
						  
						  
				var circles = svg_pca2.selectAll("circle")
										.data(data_pca2)
										.enter()
										.append("circle")
										.on("mouseover", function(d,i){tooltip(info[i]);transi_s3("pca2",9,info[i][1]);})
										.on("mouseout", function(d,i){tooltipHide(); transi_e3("pca2",9,info[i][1]);})
										.attr("minea", function(d,i){return "pca2_"+index+"_"+info[i][1];})
										.attr("class","scatter")
										.attr("cx", function(d){return xScale_pca2(0);})
										.attr("cy", function(d){return yScale_pca2(0);})
										.attr("r", 0)
										.transition()
										.delay(delay_time)
										.duration(tran_time)
										.ease(d3.easeExp)
										.attr("cx", function(d){return xScale_pca2(d[attr1]);})
										.attr("cy", function(d){return yScale_pca2(d[attr2]);})
										.attr("r", function(d, i){return (cconv(info[i][0])/2);})
										.style("fill", function(d, i){return cScale_pca2[cconv(info[i][0])];});
								
				
				if((attr1 == 0) && (attr2 == 2))
				{
					add_legend(svg_pca2, w_pca2, cScale_pca2, delay_time, tran_time);
				}
				

				svg_pca2.append("text")
						.text(attri_name[attr2])
						.attr("class", "axisLabel")
						.attr("x", w_pca2/2)
						.attr("y", h_pca2-10)
						.style("opacity", 0)
						.transition()
						.delay(delay_time)
						.duration(tran_time)
						.ease(d3.easeLinear)				
						.style("opacity", 1);						
				xAxis_pca2.scale(xScale_pca2);
				d3.select("#xAxispca2"+ attr1 + attr2)
					.transition()
					.delay(delay_time)
					.duration(tran_time)
					.ease(d3.easeLinear)				
					.call(xAxis_pca2);					
	
				svg_pca2.append("text")
						.text(attri_name[attr1])
						.attr("class", "axisLabel")
						.attr("transform", "translate(" + 15 + "," + (h_pca2/2) + ") rotate(-90)")
						.style("opacity", 0)
						.transition()
						.delay(delay_time)
						.duration(tran_time)
						.ease(d3.easeLinear)				
						.style("opacity", 1);
				yAxis_pca2.scale(yScale_pca2);
				d3.select("#yAxispca2"+ attr1 + attr2)
					.transition()
					.delay(delay_time)
					.duration(tran_time)
					.ease(d3.easeLinear)					
					.call(yAxis_pca2);									

			}
			
			
			d3.text((data_folder+"/"+year+"_info.csv"), function(text) {
					var info = d3.csvParseRows(text, function(row) {
						return row.map(function(value) { return value;});
					});
					
					d3.text(data_folder+"/attri_name.csv", function(text) {
						var attri_name = d3.csvParseRows(text, function(row) {
							return row.map(function(value) { return value;});
						});
						
						var attri_num = attri_name.length;
						for (var i=0; i<attri_num; i++)
						{	
							var ind = attri_name[i];
							attri_name[i] = variables[ind];
						}
					
						d3.text(data_folder+"/three_attri.csv", function(text) {
							var data_pca2 = d3.csvParseRows(text, function(row) {
								return row.map(function(value) { return +value;});
							});
							var num_points = data_pca2.length;
							
							var cScale_pca2 = d3.schemeCategory20;
							
							var index_m = 0;//count the order of scatter plots
							
							for(var attr1 = 0; attr1<3; attr1++)
							{
								var sub_canvas = right_canvas.append("div");
														
								var xmin_pca2 = d3.min(data_pca2, function(d){return d[attr1];});
								var xmax_pca2 = d3.max(data_pca2, function(d){return d[attr1];});
								var xpad = (xmax_pca2 - xmin_pca2)*0.02;
								var xScale_pca2 = d3.scaleLinear()
													.domain([xmin_pca2-xpad, xmax_pca2+xpad])
													.range([paddingLeft-padLeftDelta, w_pca2-paddingRight]);

								for(var attr2 = 0; attr2<3; attr2++)
								{
									var ymin_pca2 = d3.min(data_pca2, function(d){return d[attr2];});
									var ymax_pca2 = d3.max(data_pca2, function(d){return d[attr2];});
									var ypad = (ymax_pca2 - ymin_pca2)*0.02;
									var yScale_pca2 = d3.scaleLinear()
														.domain([ymin_pca2-ypad, ymax_pca2+ypad])
														.range([h_pca2-paddingBottom, paddingTop-padTopDelta]);								
								
									var svg_pca2 = sub_canvas.append("svg")
																.attr("class", "bordered")
																.attr("width" , w_pca2)
																.attr("height", h_pca2);
																
									svg_pca2.style("opacity", 0)
											.transition()
											.delay(delay_time)
											.duration(tran_time)
											.ease(d3.easeLinear)				
											.style("opacity", 1);
									
									sub_canvas.append("svg")
												.attr("width" , 4)
												.attr("height", h_pca2);
									
																		
									pca2_draw(data_pca2, svg_pca2, attr1, attr2, delay_time, tran_time, attri_name, xScale_pca2, yScale_pca2, cScale_pca2, info, index_m);
									
									index_m = index_m + 1;
									
									delay_time = delay_time + 5;
								}
							}
						});	
					});	
				});	
		}


		//----------------------------------------------------------Manifold-------------------------------------------------------------
		var toMan = function(year){
			state = 3;			
			
			var n_per_row = 3;
			w_man = Math.floor(w/(n_per_row+0.1));
			h_man = Math.floor(h/2.1);
			
			var data_folder = "./static/data/"+year;
			
			d3.selectAll(".funcc").style("background-color", "beige");
			d3.select("#toMan").style("background-color", "LightBlue");			
		
			var canvas = d3.select("#canvas");
			
			canvas.selectAll("*")
				  .remove();//cleaning
					
			canvas.style("text-align","center");			
			  
			var svg_top = canvas.append("svg")
								.attr("width" , w_man*n_per_row)
								.attr("height", 15);			  
			  
			ttip = canvas.append("div").attr("id","tooltip").attr("class","hidden");
			ttip.append("p").attr("id","rank");
			ttip.append("p").attr("id","name");			
			ttip.append("p").attr("id","country");			
		
			
			var interval = (w/n_per_row-w_man);
			var pdTop = 50;
			var xScales = [];
			var yScales = [];
			var brushCell;
			var man_draw = function(path, title, option){
				if(option == n_per_row){canvas.append("svg").attr("width" , w_man*n_per_row).attr("height", 15);}			
			
				var svg_man = canvas.append("svg")
									.attr("class", "bordered")
									.attr("width" , w_man)
									.attr("height", h_man);
									
				svg_man.append("text")
						.text(title)
						.attr("class", "title")
						.attr("x", w_man/2)
						.attr("y", pdTop/2);
						
				if(option!=(n_per_row-1) && option!=(2*n_per_row-1)){canvas.append("svg").attr("width", interval).attr("height", h_man);}
				
				d3.text((data_folder+"/"+path+".csv"), function(text) {			
					var data_man = d3.csvParseRows(text, function(row) {
						return row.map(function(value) { return +value;});
					});
					var num_points = data_man.length;				
					
					var cScale_man = d3.schemeCategory20;							  

					var xmin_man = d3.min(data_man, function(d){return d[0];});
					var xmax_man = d3.max(data_man, function(d){return d[0];});
					var xpad = (xmax_man - xmin_man)*0.03;
					var xScale_man = d3.scaleLinear()//number scale
										.domain([xmin_man-xpad, xmax_man+xpad])
										.range([10, w_man-10]);

					var ymin_man = d3.min(data_man, function(d){return d[1];});
					var ymax_man = d3.max(data_man, function(d){return d[1];});
					var ypad = (ymax_man - ymin_man)*0.03;
					var yScale_man = d3.scaleLinear()//number scale
										.domain([ymin_man-ypad, ymax_man+ypad])
										.range([h_man-10, pdTop]);
															   

					d3.text((data_folder+"/"+year+"_info.csv"), function(text) {
						var info = d3.csvParseRows(text, function(row) {
							return row.map(function(value) { return value;});
						});

						var tran_c = 500;					
						var delay_time = option;

						var circles = svg_man.selectAll("circle")
												.data(data_man, function(d) { return d.name; })
												.enter()
												.append("circle")
												.attr("minea", function(d,i){return "man_"+option+"_"+info[i][1];})
												.attr("class","scatter")
												.attr("id",function(d,i){return "c_"+option+"_"+i;})
												.on("mouseover", function(d,i){tooltip(info[i]);transi_s3("man",(n_per_row*2),info[i][1]);})
												.on("mouseout", function(d,i){tooltipHide(); transi_e3("man",(n_per_row*2),info[i][1]);})
												.attr("cx", function(d){return xScale_man(0);})
												.attr("cy", function(d){return yScale_man(0);})
												.attr("r", 0)
												.transition()
												.delay(delay_time)
												.duration(tran_c)
												.ease(d3.easeExp)
												.attr("cx", function(d){return xScale_man(d[0]);})
												.attr("cy", function(d){return yScale_man(d[1]);})
												.attr("r", function(d, i){return cconv(info[i][0]);})
												.style("fill", function(d, i){return cScale_man[cconv(info[i][0])];});
											

						
						
						if(option==(0)){add_legend(svg_man, 122, cScale_man, delay_time);}
						
						var brushn = d3.brush()
										.extent([[10, pdTop], [w_man-10, h_man-10]])
										.on("start", brushStart)
										.on("brush", brushMove)
										.on("end", brushEnd);
						
						svg_man.append("g")
								.attr("id",function(d){return "brush"+option;})				
								.attr("class", "brush")
								.call(brushn);						
										
						function brushMove() {				
							var s = d3.event.selection;
							if(s)
							{					
								var x0 = s[0][0],
									y0 = s[0][1],
									x1 = s[1][0],
									y1 = s[1][1],
									dx = x1 - x0,
									dy = y1 - y0;

								if (dx && dy) {
									var svgidx = +(d3.select(this).attr("id")[5]);
									var x = xScales[svgidx];				
									var extentx = [x.invert(x0),x.invert(x1)];
									var y = yScales[svgidx];
									var extenty = [y.invert(y1),y.invert(y0)];	
								
									for (var k=0; k<num_points; k++)
									{
										var circle_cur = d3.select("#c_"+svgidx+"_"+k);
										circle_cur.classed("hidden",function(d){
											var bhidden = ( extentx[0] > d[0] || d[0] > extentx[1] || extenty[0] > d[1] || d[1] > extenty[1]);
											for(var j=0; j<n_per_row*2; j++)
											{
												d3.select("#c_"+j+"_"+k).classed("hidden",bhidden);
											}
											return bhidden;
										});
									}
								}
							}
						}

						function brushStart() {
							if (brushCell !== this){
								d3.select(brushCell).call(brushn.move,null);
								brushCell = this;
							}
						}

						function brushEnd() {
							if (!d3.event.selection) d3.selectAll(".hidden").classed("hidden", false);
						}
					});

					xScales.push(xScale_man);
					yScales.push(yScale_man);
				});
								
			}		

			man_draw("lle_std", "Standard Locally Linear Embedding", 0);
			man_draw("iso", "Isomap", 1);
			man_draw("mds_euc", "MDS using the Euclidean metric", 2);
			man_draw("lle_modified", "Modified Locally Linear Embedding", 3);
			man_draw("se", "Spectral Embedding", 4);
			man_draw("tsne", "t-Distributed Stochastic Neighbor Embedding", 5);			
		}		
		
		
		//----------------------------------------------------------Clustering-------------------------------------------------------------
		var toClu = function(year){
			state = 4;			
					
			var data_folder = "./static/data/"+year;
			
			d3.selectAll(".funcc").style("background-color", "beige");
			d3.select("#toClu").style("background-color", "LightBlue");			
		
			d3.select("#canvas")
			  .selectAll("*")
			  .remove();//cleaning
			  
			var svg_top = d3.select("#canvas")
							.append("svg")
							.attr("width" , w)
							.attr("height", 40);			  
			  
			ttip = d3.select("#canvas").append("div").attr("id","tooltip").attr("class","hidden");
			ttip.append("p").attr("id","rank");
			ttip.append("p").attr("id","name");			
			ttip.append("p").attr("id","country");
			  
			d3.select("#canvas")
				.style("text-align","center");

			//-----------------------------------------MDS and Isomap-----------------------------------------
			var w_left = Math.floor(w/3.1);
			var h_left = Math.floor(h/1.1);
			var interval = 30;
			var h_mds = (h_left-interval)/2;
			var pdTop = 50;
			
			var num_points = 0;
			
			var mds_draw = function(text, svg_mds, option){
				var data_mds = d3.csvParseRows(text, function(row) {
					return row.map(function(value) { return +value;});
				});
				num_points = data_mds.length;				
				
				var cScale_mds = d3.schemeCategory20;						  

				var xmin_mds = d3.min(data_mds, function(d){return d[0];});
				var xmax_mds = d3.max(data_mds, function(d){return d[0];});
				var xpad = (xmax_mds - xmin_mds)*0.03;
				var xScale_mds = d3.scaleLinear()//number scale
									.domain([xmin_mds-xpad, xmax_mds+xpad])
									.range([10, w_left-10]);

				var ymin_mds = d3.min(data_mds, function(d){return d[1];});
				var ymax_mds = d3.max(data_mds, function(d){return d[1];});
				var ypad = (ymax_mds - ymin_mds)*0.03;
				var yScale_mds = d3.scaleLinear()//number scale
									.domain([ymin_mds-ypad, ymax_mds+ypad])
									.range([h_mds-10, pdTop]);
														   

				d3.text((data_folder+"/"+year+"_info.csv"), function(text) {
					var info = d3.csvParseRows(text, function(row) {
						return row.map(function(value) { return value;});
					});

					var tran_c = 500;					
					var delay_time = option;

					var circles = svg_mds.selectAll("circle")
											.data(data_mds, function(d) { return d.name; })
											.enter()
											.append("circle")
											.on("mouseover", function(d,i){tooltip(info[i]);transi_s2("clu",info[i][1], num_points);})
											.on("mouseout", function(d,i){tooltipHide(); transi_e2("clu",info[i][1], num_points);})
											.attr("minea", function(d,i){return "clu_"+option+"_"+info[i][1];})
											.attr("class","scatter")
											.attr("id",function(d,i){return ("c"+option+"_"+i);})
											.attr("cx", function(d){return xScale_mds(0);})
											.attr("cy", function(d){return yScale_mds(0);})
											.attr("r", 0)
											.transition()
											.delay(delay_time)
											.duration(tran_c)
											.ease(d3.easeExp)
											.attr("cx", function(d){return xScale_mds(d[0]);})
											.attr("cy", function(d){return yScale_mds(d[1]);})
											.attr("r", function(d, i){return cconv(info[i][0]);})
											.style("fill", function(d, i){return cScale_mds[cconv(info[i][0])];});
					
					
					if(option==0){add_legend(svg_mds, 122, cScale_mds, delay_time);}
				});
			}	
			
			var canvas_left = d3.select("#canvas")
								.append("div")
								.style("width" , w_left+"px")
								.style("height", h_left+"px")
								.style("text-align","center")
								.style("display","inline-block");
						
			var svg_mds = canvas_left.append("div")
									 .attr("class","bordered")
									 .append("svg")
									 .attr("width" , w_left)
									 .attr("height", (h_mds-4))
									 .style("margin",0);
								
			svg_mds.append("text")
					.text("MDS using the Euclidean metric")
					.attr("class", "title")
					.attr("x", w_left/2)
					.attr("y", pdTop/2);
			
			d3.text(data_folder+"/mds_euc.csv", function(text) {mds_draw(text, svg_mds, 0);});
			
			canvas_left.append("div").style("width", w_left+"px").style("height", interval+"px");

			var svg_iso = canvas_left.append("div")
									 .attr("class","bordered")
									 .append("svg")
									 .attr("width" , w_left)
									 .attr("height", (h_mds-4))
									 .style("margin",0);
								
			svg_iso.append("text")
						.text("Isomap")
						.attr("class", "title")
						.attr("x", w_left/2)
						.attr("y", pdTop/2);
			
			d3.text(data_folder+"/iso.csv", function(text) {mds_draw(text, svg_iso, 1);});

			
			//--------------------------------------Parallel Coordinates-----------------------------------------
			var interval_hor = 30;
			var w_pc = w-w_left-interval_hor;
			var pTop = 60;	
			var h_pc = h_left - pTop;
			var pTop_pc = 20;

			d3.select("#canvas")
				.append("div")
				.style("width" , interval_hor+"px")
				.style("height", h_left+"px")
				.style("display","inline-block");			
			
			var canvas_pc = d3.select("#canvas")
								.append("div")
								.style("width" , w_pc+"px")
								.style("height", h_left+"px")
								.style("text-align","center")
								.style("display","inline-block")
								.append("div")
								.attr("class", "bordered");
			
			canvas_pc.append("div").style("width" , w_pc+"px").style("height", 10+"px");
			var catop = canvas_pc.append("div").style("width" , w_pc+"px").style("height", 50+"px").style("text-align","center");
			var toptable = catop.append("table").style("align","center");
			var toptr = toptable.append("tr");

			toptr.append("td").append("button").attr("id","resetorder").attr("class","funcc").text("Reset Order");
			toptr.append("td").append("text").text("\u00A0\u00A0\u00A0");
			toptr.append("td").append("text")
					.text("Parallel Coordiantes")
					.attr("class", "title");
			toptr.append("td").append("text").text("\u00A0\u00A0\u00A0");		
			toptr.append("td").append("button").attr("id","resetbrush").attr("class","funcc").text("Reset Brush");
			
			var svg_pc = canvas_pc.append("svg")
									.attr("width" , w_pc)
									.attr("height", h_pc);
									
			var cScale_pc = d3.schemeCategory20;									
			
			d3.text(data_folder+"/"+year+"_data.csv", function(text) {
				var data = d3.csvParseRows(text, function(row) {
					return row.map(function(value) { return +value;});
				});
				
				num_points = data.length;
				
				d3.text((data_folder+"/"+year+"_info.csv"), function(text) {
					var info = d3.csvParseRows(text, function(row) {
						return row.map(function(value) { return value;});
					});

					var dimensions = ["teach","int.","rsch.","cita.","income","# stu.","SSR","ISP","FMR"];
					
					var x_pc = d3.scaleBand()
									.domain(dimensions)
									.rangeRound([paddingLeft, w_pc+60])
									.padding(0);
						
					var y_pc = {};
					for (var i=0; i<5; i++)
					{
						y_pc[dimensions[i]] = d3.scaleLinear()
												.domain([0,100])
												.range([h_pc-paddingBottom, pTop_pc]);
					}					
					for (var i=5; i<9; i++)
					{
						var ymin = d3.min(data, function(d){return d[i];});
						var ymax = d3.max(data, function(d){return d[i];});
						var ypad = (ymax - ymin)*0.02;
						y_pc[dimensions[i]] = d3.scaleLinear()
												.domain([ymin-ypad, ymax+ypad])
												.range([h_pc-paddingBottom, pTop_pc]);
					}										
						
					var dragging = {};

					var line = d3.line();

					var tran_c = 500;					
					var delay_time = 0;					
					
					// Add grey background lines for context.
					var background = svg_pc.append("g")
											.attr("class", "background")
											.selectAll("path")
											.data(data)
											.enter()
											.append("path")											
											.attr("d", path)
											.attr("mineah", function(d,i){return "clu_"+info[i][1];})
											.attr("class","pclines");

					// Add blue foreground lines for focus.
					var foreground = svg_pc.append("g")
											.attr("class", "foreground")
											.selectAll("path")
											.data(data)
											.enter()
											.append("path")
											.attr("d", path)											
											.style("stroke", function(d, i){return cScale_pc[cconv(info[i][0])];})
											.on("mouseover", function(d,i){tooltip(info[i]);transi_s2("clu",info[i][1], num_points);})
											.on("mouseout", function(d,i){tooltipHide(); transi_e2("clu",info[i][1], num_points);})
											.attr("minea", function(d,i){return "clu_"+info[i][1];})
											.attr("class","pclines");

					// Add a group element for each dimension.
					var g = svg_pc.selectAll(".dimension")
									.data(dimensions)
									.enter()
									.append("g")
									.attr("class", "dimension")
									.attr("transform", function(d) { return "translate(" + x_pc(d) + ",0)"; })
									.call(d3.drag()
											.subject(function(d) {return {x: x_pc(d)};})
											.on("start", function(d) {
											  dragging[d] = x_pc(d);
											  background.attr("visibility", "hidden");
											})
											.on("drag", function(d) {
												dragging[d] = Math.min(w_pc, Math.max(0, d3.event.x));
												foreground.attr("d", path).style("stroke", function(d, i){return cScale_pc[cconv(info[i][0])];});
												dimensions.sort(function(a, b) { return position(a) - position(b); });
												x_pc.domain(dimensions);
												g.attr("transform", function(d) { return "translate(" + position(d) + ",0)"; })
											})
											.on("end", function(d) {
												delete dragging[d];
												d3.select(this)
													.transition()
													.duration(500)
													.attr("transform", "translate(" + x_pc(d) + ",0)");
												foreground.transition()
															.duration(500)
															.attr("d", path)
															.style("stroke", function(d, i){return cScale_pc[cconv(info[i][0])];});
												background.attr("d", path)
															.transition()
															.delay(500)
															.duration(0)
															.attr("visibility", null);
											})
									);

					var	axis = d3.axisLeft();
					
					// Add an axis and title.
					g.append("g")
						.attr("class", "axis")
						.each(function(d) {	d3.select(this).call(d3.axisLeft(y_pc[d]));})
						.append("text")
						.style("text-anchor", "middle")
						.style("fill", "black")
						.attr("y", (pTop_pc/2))
						.text(function(d) { return d; })
						.on("click",function(d,i){brush_click(d,i);});
					
					var extents = {};
					for(var i=0; i<dimensions.length; i++)
					{
						extents[dimensions[i]] = [0,0];
					}
					
					g.append("g")
						.attr("id",function(d){return "brush"+lookuptable[d];})				
						.attr("class", "brush")
						.each(function(d) {
							d3.select(this).call(y_pc[d].brush = d3.brushY().extent([[-8, pTop_pc], [8, h_pc-paddingBottom]]).on("start", brushstart).on("brush", brush));
						})			
						.selectAll("rect")
						.attr("x", -8)
						.attr("width", 16);				

					function position(d) {
					  var v = dragging[d];
					  return v == null ? x_pc(d) : v;
					}

					// Returns the path for a given data point.
					function path(d) {
					  return line(dimensions.map(function(p) { return [position(p), y_pc[p](d[lookuptable[p]])]; }));
					}

					function brushstart() {
					  d3.event.sourceEvent.stopPropagation();
					}

					
					function brush() {
						for(var j=0;j<dimensions.length;++j){
							if(d3.event.target==y_pc[dimensions[j]].brush && d3.event.selection) {
								extents[dimensions[j]]=d3.event.selection.map(y_pc[dimensions[j]].invert,y_pc[dimensions[j]]);
							}
						}
						
						d3.selectAll(".scatter").style("opacity",0.1);	
						
						foreground.style("display", function(d, i) {
							var selected =  dimensions.every(function(p, i) {
								if(extents[p][0]==0 && extents[p][1]==0) {return true;}
								else{return extents[p][1] <= d[lookuptable[p]] && d[lookuptable[p]] <= extents[p][0];}
							})
							
							if(selected)
							{
								var name = info[i][1];
								for(var index=0; index<2; index++)
								{
									var node_cur = d3.select('circle[minea="clu_'+index+'_'+name+'"]');
									node_cur.style("opacity",1.0);
								}
							}
							
							return (selected? null : "none");
						});
					}

					function brush_click(d,i){
						extents[d] = [0,0];
						background.style("display",null);
						d3.select("#brush"+lookuptable[d]).call(y_pc[d].brush.move, null);				
					}


					function rstbrush(){
						for(var i=0; i<dimensions.length; i++)
						{
							var attname = dimensions[i];
							extents[attname] = [0,0];
							d3.select("#brush"+lookuptable[attname]).call(y_pc[attname].brush.move, null);	
						}					
					}
					
					function rstorder(){
						dimensions = ["teach","int.","rsch.","cita.","income","# stu.","SSR","ISP","FMR"];
						x_pc.domain(dimensions);
						g.attr("transform", function(d) { return "translate(" + x_pc(d) + ",0)"; });
						foreground.attr("d", path).style("stroke", function(d, i){return cScale_pc[cconv(info[i][0])];});
						background.attr("d", path).attr("visibility", null);				
					}
					
					d3.select("#resetorder").on("click",function(){rstorder();});
					d3.select("#resetbrush").on("click",function(){rstbrush();});
				});	
			});			
		}
				

		
		var radio = function()
		{
			var year = +(d3.select('input[name="method"]:checked').property("value"));
			d3.select('#toPCA1').on("click",function(){toPCA1(year);});
			d3.select('#toPCA2').on("click",function(){toPCA2(year);});
			d3.select('#toMan').on("click",function(){toMan(year);});
			d3.select('#toClu').on("click",function(){toClu(year);});	
			if(state == 1){toPCA1(year);}
			else if(state == 2){toPCA2(year);}
			else if(state == 3){toMan(year);}
			else if(state == 4){toClu(year);}
		}
		
		d3.selectAll('input[name="method"]').on("click",function(){radio();});
		
		d3.select("c2016").property("checked", "true");
		state = 1;
		radio();
		
	</script>

	
</body>